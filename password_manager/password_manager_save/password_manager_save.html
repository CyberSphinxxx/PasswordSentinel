<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Save Password - PasswordSentinel</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/password_manager/password_manager_save/password_manager_save_styles.css">
    <link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&display=swap" rel="stylesheet">
    <style>
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="header-logo">
                <a href="/index.html">PasswordSentinel</a>
            </div>
            <nav class="header-nav">
                <ul class="header-nav-menu">
                    <li class="header-nav-item">
                        <a href="/dashboard/dashboard.html" class="header-nav-link">Dashboard</a>
                    </li>

                    <li class="header-nav-item">
                        <a href="/password_generator/passwordgen.html" class="header-nav-link">Password Generator</a>
                    </li>

                    <li class="header-nav-item">
                        <a href="/password_manager/password_manager_save/password_manager_save.html" class="header-nav-link">Save Password</a>
                    </li>

                    <li class="header-nav-item">
                        <a href="/password_manager/password_manager_view/password_manager_view.html" class="header-nav-link">View Passwords</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="main-content">
        <div class="save-password-container">
            <h1>Save New Password</h1>
            <form class="save-password-form" id="savePasswordForm">
                <div class="form-group">
                    <label for="label">Label/Website</label>
                    <input type="text" id="label" required 
                           placeholder="e.g., Gmail, Facebook, Netflix">
                </div>

                <div class="form-group">
                    <label for="username">Username/Email</label>
                    <input type="text" id="username" required
                           placeholder="Enter username or email">
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required
                           placeholder="Enter password">
                    <div class="password-requirements">
                        Password should contain:
                        <ul>
                            <li>At least 8 characters</li>
                            <li>Uppercase and lowercase letters</li>
                            <li>Numbers and special characters</li>
                        </ul>
                    </div>
                    <div class="strength-indicator" id="strengthIndicator"></div>
                </div>

                <div class="form-buttons">
                    <button type="submit" class="save-btn">Save Password</button>
                    <button type="button" class="clear-btn" onclick="clearForm()">Clear Form</button>
                </div>
            </form>
            <div class="success-message" id="successMessage">Password saved successfully!</div>
            <div class="error-message" id="errorMessage"></div>
        </div>
    </div>

    <script>
        // Get form elements
        const form              = document.getElementById('savePasswordForm');
        const passwordInput     = document.getElementById('password');
        const strengthIndicator = document.getElementById('strengthIndicator');
        const successMessage    = document.getElementById('successMessage');
        const errorMessage      = document.getElementById('errorMessage');
    
        // Clear invalid localStorage data on page load
        function clearInvalidLocalStorage() {
            try {
                JSON.parse(localStorage.getItem('savedPasswords'));
            } catch (error) {
                console.warn('Invalid data in localStorage. Clearing savedPasswords.');
                localStorage.removeItem('savedPasswords');
            }
        }
        clearInvalidLocalStorage();
    
        // Password strength evaluation function
        function evaluatePasswordStrength(password) {
            let strength = 0;
            const checks = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                numbers: /\d/.test(password),
                symbols: /[^A-Za-z0-9]/.test(password)
            };
    
            strength += checks.length ? 1 : 0;
            strength += checks.uppercase ? 1 : 0;
            strength += checks.lowercase ? 1 : 0;
            strength += checks.numbers ? 1 : 0;
            strength += checks.symbols ? 1 : 0;
    
            if (strength <= 2) return 'Weak';
            if (strength <= 4) return 'Medium';
            return 'Strong';
        }
    
        // Update strength indicator as user types
        passwordInput.addEventListener('input', function() {
            const strength = evaluatePasswordStrength(this.value);
            strengthIndicator.textContent = `Password Strength: ${strength}`;
            strengthIndicator.className = `strength-indicator strength-${strength.toLowerCase()}`;
        });
    
        // Encrypt data function
        async function encryptData(data) {
            const jsonData = JSON.stringify(data);
            const encodedData = btoa(jsonData); // Base64 encoding
            return encodedData;
        }
    
        // Handle form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
    
            const passwordData = {
                label: document.getElementById('label').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                dateAdded: new Date().toISOString()
            };
    
            try {
                // Encrypt password data
                const encryptedData = await encryptData(passwordData);
    
                // Get existing passwords from localStorage
                let savedPasswords;
                try {
                    savedPasswords = JSON.parse(localStorage.getItem('savedPasswords') || '[]');
                } catch (parseError) {
                    console.error('Error parsing saved passwords:', parseError);
                    savedPasswords = [];
                }
    
                // Ensure savedPasswords is an array
                if (!Array.isArray(savedPasswords)) {
                    savedPasswords = [];
                }
    
                // Add new encrypted data to the array
                savedPasswords.push(encryptedData);
    
                // Save updated array back to localStorage
                localStorage.setItem('savedPasswords', JSON.stringify(savedPasswords));
    
                successMessage.style.display = 'block';
                errorMessage.style.display   = 'none';
                clearForm();
            } catch (error) {
                errorMessage.textContent     = 'Error saving password: ' + error.message;
                errorMessage.style.display   = 'block';
                successMessage.style.display = 'none';
            }
        });
    
        // Clear form function
        function clearForm() {
            document.getElementById('label').value    = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            strengthIndicator.textContent = '';
            successMessage.style.display  = 'none';
            errorMessage.style.display    = 'none';
        }
    </script>
</body>
</html>